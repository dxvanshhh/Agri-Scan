<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agri-Scan: Leaf Scan</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="vanta-bg"></div>

    <nav>
        <a href="index.html" class="logo">üåø Agri-Scan</a>
        <div class="nav-links">
            <a href="index.html" data-key="nav_home">Home</a>
            <a href="scan.html" data-key="nav_scan">Leaf Scan</a>
            <a href="field_scan.html" data-key="nav_field_scan">Field Scan</a>
            <a href="about.html" data-key="nav_about">About</a>
            <a href="project.html" data-key="nav_project">Project Details</a>
            <div class="lang-toggle">
                <button id="lang-en" class="active">EN</button>
                <button id="lang-hi">HI</button>
            </div>
            <div class="notification-bell">
                <span class="bell-icon" id="bell-icon">üîî</span>
                <span class="dot" id="bell-dot"></span>
                <div class="notification-dropdown" id="notification-menu">
                    <div class="header" data-key="alert_title">Proactive Alerts</div>
                    <div class="alert-item"><strong data-key="alert_1_title">FUNGAL ALERT</strong><div data-key="alert_1_body">High humidity in your area increases risk for Late Blight.</div><div class="time">1 hour ago</div></div>
                    <div class="alert-item"><strong data-key="alert_2_title">VIRUS ALERT</strong><div data-key="alert_2_body">Whitefly populations detected nearby. Monitor tomatoes for Yellow Leaf Curl Virus.</div><div class="time">1 day ago</div></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="weather-card" id="weather-card">
                <h2 data-key="weather_title">Local Weather Conditions</h2>
                <div class="weather-item">
                    <div class="label" data-key="weather_temp">Temperature</div>
                    <div class="value" id="weather-temp-value">--</div>
                </div>
                <div class="weather-item">
                    <div class="label" data-key="weather_humidity">Humidity</div>
                    <div class="value" id="weather-humidity-value">--</div>
                </div>
            </div>

            <h1 data-key="scan_title">AI Diagnostic Scan (Model A)</h1>
            <input type="file" id="imageUpload" accept="image/*" />
            <img id="image-preview" />
            <div class="spinner" id="loading-spinner"></div>
            
            <div id="results-container">
                <p data-key="scan_prompt">Please upload a single leaf image for analysis.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.net.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    
    <script src="lang.js"></script> <script>
        // Start 3D Background
        VANTA.NET({ el: "#vanta-bg", /* ... 3D settings ... */ mouseControls: true, touchControls: true, minHeight: 200.00, minWidth: 200.00, scale: 1.00, scaleMobile: 1.00, color: 0x3bff84, backgroundColor: 0x1a2a1a, points: 10.00, maxDistance: 25.00, spacing: 18.00 });

        // --- ‚ùóÔ∏è‚ùóÔ∏è YOUR API KEYS ‚ùóÔ∏è‚ùóÔ∏è ---
        // If you don't have a key, just leave this blank. The scan will still work.
        const API_KEY = "87707b9e371a4aff02a2e525b4c7482e"; // 1. PASTE YOUR OPENWEATHERMAP KEY HERE (optional)
        const URL = "https://teachablemachine.withgoogle.com/models/3ay25TfYM/"; // 2. Your AI Model
        const CONFIDENCE_THRESHOLD = 0.90; // 3. Your Safety Threshold

        let model, maxPredictions;
        const imageUpload = document.getElementById("imageUpload");
        const imagePreview = document.getElementById("image-preview");
        const resultsDiv = document.getElementById("results-container");
        const spinner = document.getElementById("loading-spinner");
        const weatherCard = document.getElementById("weather-card");

        let currentTemp = null;
        let currentHumidity = null;

        async function init() {
            try {
                model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                maxPredictions = model.getTotalClasses();
            } catch (e) {
                resultsDiv.innerHTML = "<h2>Error: Could not load AI model.</h2>";
            }
        }
        init(); 

        imageUpload.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (!file) return;
            imagePreview.style.display = "block";
            resultsDiv.innerHTML = ""; 
            weatherCard.style.display = "none";
            spinner.style.display = "block"; 
            
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                getRealTimeWeather(() => {
                    setTimeout(() => analyzeImage(imagePreview), 100);
                });
            };
            reader.readAsDataURL(file);
        });

        function getRealTimeWeather(callback) {
            // --- THIS IS THE FIX: Check if API key even exists ---
            if (!API_KEY) {
                console.log("No API key. Skipping weather.");
                callback();
                return;
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    fetchWeather(lat, lon, callback);
                }, (err) => { callback(); }); // Geolocation failed, skip
            } else { callback(); } // Geolocation not supported, skip
        }

        async function fetchWeather(lat, lon, callback) {
            const API_URL = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${API_KEY}&units=metric`;
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Weather API failed');
                const data = await response.json();
                
                currentTemp = data.main.temp;
                currentHumidity = data.main.humidity;

                document.getElementById("weather-temp-value").innerText = `${currentTemp.toFixed(0)}¬∞C`;
                document.getElementById("weather-humidity-value").innerText = `${currentHumidity}%`;
                weatherCard.style.display = "grid";
                callback();
            } catch (error) {
                console.error("Weather fetch error:", error);
                callback(); // Skip even if weather fails
            }
        }

        async function analyzeImage(imageElement) {
            const prediction = await model.predict(imageElement);
            let bestClass = "", bestProb = 0;
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > bestProb) {
                    bestProb = prediction[i].probability;
                    bestClass = prediction[i].className;
                }
            }
            spinner.style.display = "none";
            
            let diagnosisKey, insightKeys;
            let confidence = (bestProb * 100).toFixed(0);

            if (bestProb < CONFIDENCE_THRESHOLD) {
                diagnosisKey = "diag_unknown";
                insightKeys = ["insight_unknown_1", "insight_unknown_2"];
            } else {
                
                // --- ‚úÖ THIS SECTION IS NOW 100% CORRECTED ---
                // It uses the HUMAN-READABLE names (with spaces and dashes)
                switch (bestClass) {
                    // --- Tomato ---
                    case "Tomato - Bacterial Spot": diagnosisKey = "diag_tomato_bacterial_spot"; insightKeys = ["insight_copper_spray", "insight_avoid_overhead_water"]; break;
                    case "Tomato - Early Blight": diagnosisKey = "diag_tomato_early_blight"; insightKeys = ["insight_remove_lower_leaves", "insight_fungicide_chlorothalonil"]; break;
                    case "Tomato - Late Blight": diagnosisKey = "diag_tomato_late_blight"; insightKeys = ["insight_remove_leaves", "insight_copper_fungicide"]; break;
                    case "Tomato - Leaf Mold": diagnosisKey = "diag_tomato_leaf_mold"; insightKeys = ["insight_improve_airflow", "insight_fungicide_chlorothalonil"]; break;
                    case "Tomato - Septoria Leaf Spot": diagnosisKey = "diag_tomato_septoria"; insightKeys = ["insight_remove_leaves", "insight_fungicide_chlorothalonil"]; break;
                    case "Tomato - Spider Mites Two-spotted Spider Mite": diagnosisKey = "diag_tomato_spider_mites"; insightKeys = ["insight_miticide_spray", "insight_increase_humidity"]; break;
                    case "Tomato - Target Spot": diagnosisKey = "diag_tomato_target_spot"; insightKeys = ["insight_improve_airflow", "insight_copper_fungicide"]; break;
                    case "Tomato - Yellow Leaf Curl Virus": diagnosisKey = "diag_tomato_yellow_virus"; insightKeys = ["insight_remove_infected_plants", "insight_control_whiteflies"]; break;
                    case "Tomato - Mosaic Virus": diagnosisKey = "diag_tomato_mosaic_virus"; insightKeys = ["insight_remove_infected_plants", "insight_control_insects"]; break;
                    case "Tomato - Healthy": diagnosisKey = "diag_tomato_healthy"; insightKeys = ["insight_healthy"]; break;
                    
                    // --- Potato ---
                    case "Potato - Early Blight": diagnosisKey = "diag_potato_early_blight"; insightKeys = ["insight_fungicide_chlorothalonil", "insight_crop_rotation"]; break;
                    case "Potato - Late Blight": diagnosisKey = "diag_potato_late_blight"; insightKeys = ["insight_destroy_plants", "insight_targeted_fungicide"]; break;
                    case "Potato - Healthy": diagnosisKey = "diag_potato_healthy"; insightKeys = ["insight_healthy"]; break;
                    
                    // --- Corn (Maize) ---
                    case "Corn - Cercospora Leaf Spot Gray Leaf Spot": diagnosisKey = "diag_corn_gray_spot"; insightKeys = ["insight_crop_rotation", "insight_fungicide_if_severe"]; break;
                    case "Corn - Common Rust": diagnosisKey = "diag_corn_common_rust"; insightKeys = ["insight_resistant_varieties", "insight_fungicide_if_severe"]; break;
                    case "Corn - Northern Leaf Blight": diagnosisKey = "diag_corn_northern_blight"; insightKeys = ["insight_crop_rotation", "insight_resistant_varieties"]; break;
                    case "Corn - Healthy": diagnosisKey = "diag_corn_healthy"; insightKeys = ["insight_healthy"]; break;

                    // --- Strawberry ---
                    case "Strawberry - Leaf Scorch": diagnosisKey = "diag_strawberry_leaf_scorch"; insightKeys = ["insight_remove_infected_leaves", "insight_fungicide_captan"]; break;
                    case "Strawberry - Healthy": diagnosisKey = "diag_strawberry_healthy"; insightKeys = ["insight_healthy"]; break;
                    
                    // --- Apple ---
                    case "Apple - Apple Scab": diagnosisKey = "diag_apple_scab"; insightKeys = ["insight_fungicide_captan", "insight_remove_fallen_leaves"]; break;
                    case "Apple - Black Rot": diagnosisKey = "diag_apple_black_rot"; insightKeys = ["insight_prune_dead_wood", "insight_fungicide_captan"]; break;
                    case "Apple - Cedar Apple Rust": diagnosisKey = "diag_apple_cedar_rust"; insightKeys = ["insight_fungEicide_myclobutanil", "insight_remove_juniper"]; break;
                    case "Apple - Healthy": diagnosisKey = "diag_apple_healthy"; insightKeys = ["insight_healthy"]; break;
                    
                    // --- Bell Pepper ---
                    case "Bell Pepper - Bacterial Spot": diagnosisKey = "diag_pepper_bacterial_spot"; insightKeys = ["insight_copper_spray", "insight_crop_rotation"]; break;
                    case "Bell Pepper - Healthy": diagnosisKey = "diag_pepper_healthy"; insightKeys = ["insight_healthy"]; break;
                    
                    // --- Cherry ---
                    case "Cherry - Powdery Mildew": diagnosisKey = "diag_cherry_powdery_mildew"; insightKeys = ["insight_fungicide_sulfur", "insight_improve_airflow"]; break;
                    case "Cherry - Healthy": diagnosisKey = "diag_cherry_healthy"; insightKeys = ["insight_healthy"]; break;
                    
                    // --- Grape ---
                    case "Grape - Black Rot": diagnosisKey = "diag_grape_black_rot"; insightKeys = ["insight_fungicide_captan", "insight_remove_mummies"]; break;
                    case "Grape - Esca (Black Measles)": diagnosisKey = "diag_grape_esca"; insightKeys = ["insight_prune_dead_wood", "insight_no_chemical_cure"]; break;
                    case "Grape - Leaf Blight (Isariopsis Leaf Spot)": diagnosisKey = "diag_grape_leaf_blight"; insightKeys = ["insight_fungicide_captan", "insight_improve_airflow"]; break;
                    case "Grape - Healthy": diagnosisKey = "diag_grape_healthy"; insightKeys = ["insight_healthy"]; break;
                    
                    // --- Peach ---
                    case "Peach - Bacterial Spot": diagnosisKey = "diag_peach_bacterial_spot"; insightKeys = ["insight_copper_spray", "insight_prune_peach"]; break;
                    case "Peach - Healthy": diagnosisKey = "diag_peach_healthy"; insightKeys = ["insight_healthy"]; break;
                    
                    default:
                        diagnosisKey = "diag_default";
                        insightKeys = ["insight_no_data"];
                }

                // --- Add "Smarter" Insights based on weather ---
                if (currentHumidity > 80 && (bestClass.includes("Blight") || bestClass.includes("Mold") || bestClass.includes("Scab") || bestClass.includes("Rust"))) {
                    insightKeys.push("insight_weather_fungal"); // Add fungal warning
                }
                if (currentTemp > 25 && bestClass.includes("Virus")) {
                    insightKeys.push("insight_weather_viral"); // Add viral/insect warning
                }
            }
            
            // This function builds the HTML AND translates it
            renderResults(diagnosisKey, insightKeys, confidence, bestClass);
        }

        // This function builds the results box
        function renderResults(diagnosisKey, insightKeys, confidence, bestClass) {
            const lang = getCurrentLanguage();
            let insightsHTML = insightKeys.map(key => `<li>${translations[lang][key] || key}</li>`).join("");
            // --- ‚úÖ THIS IS THE FIX ---
            // It now uses the diagnosisKey to get the translation, NOT the raw bestClass name
            let diagnosisText = translations[lang][diagnosisKey] || bestClass;
            
            // It now checks for "Healthy" in the *class name*, which is more reliable
            let h2_style = (bestClass.includes("Healthy")) ? 'style="color: #8eff8e;"' : '';
            
            // --- FINAL BUTTON LOGIC ---
            let buttonsHTML = '';
            if (diagnosisKey.includes("diag_unknown")) {
                // 1. Show "Report Pest" button if AI fails
                buttonsHTML = `
                    <button class="report-button" data-key="btn_report_pest" onclick="reportPest()">
                        ${translations[lang]["btn_report_pest"]}
                    </button>
                `;
            } else if (!bestClass.includes("Healthy")) {
                // 2. Show "Supplier/Expert" buttons if it's a known disease
                buttonsHTML = `
                    <div class="action-buttons">
                        <a href="https://www.google.com/maps/search/agricultural+suppliers+near+me" target="_blank" class="btn-primary" data-key="btn_buy_medicine">${translations[lang]["btn_buy_medicine"]}</a>
                        <a href="https://mkisan.gov.in/Alpha/aboutkcc.aspx" target="_blank" class="btn-secondary" data-key="btn_consult_expert">${translations[lang]["btn_consult_expert"]}</a>
                    </div>
                `;
            }
            // 3. No buttons are shown if it's "Healthy"

            resultsDiv.innerHTML = `
                <h2 ${h2_style} data-key="${diagnosisKey}">${diagnosisText}</h2>
                <p><strong>Confidence:</strong> ${confidence}%</p><hr>
                <h3 data-key="scan_insights_title">${translations[lang]["scan_insights_title"]}</h3>
                <ul>${insightsHTML}</ul>
                ${buttonsHTML}
            `;
        }

        // --- Function for the "Report Pest" button ---
        function reportPest() {
            const lang = getCurrentLanguage();
            alert(translations[lang]["report_success"]);
        }
    </script>
</body>
</html>